<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>연구소 통합 관리 시스템</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100">
    <!-- 로그인 화면 -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-md w-96">
            <h1 class="text-2xl font-bold mb-6 text-center">연구소 통합 관리 시스템</h1>
            <input type="email" id="loginEmail" placeholder="이메일" 
                   class="w-full p-2 border rounded mb-3">
            <input type="password" id="loginPassword" placeholder="비밀번호" 
                   class="w-full p-2 border rounded mb-4">
            <button onclick="login()" 
                    class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">
                로그인
            </button>
            <div id="loginError" class="text-red-500 text-sm mt-2 hidden"></div>
        </div>
    </div>

    <!-- 메인 대시보드 -->
    <div id="dashboard" class="hidden">
        <div class="flex h-screen">
            <!-- 사이드바 -->
            <div class="w-64 bg-gray-800 text-white p-4">
                <div class="mb-8">
                    <h2 class="text-xl font-bold">연구소 시스템</h2>
                    <p id="userName" class="text-sm text-gray-400 mt-1"></p>
                    <p id="userRole" class="text-xs text-gray-500"></p>
                </div>
                
                <nav class="space-y-2">
                    <a href="#" onclick="showTab('overview')" 
                       class="block px-4 py-2 rounded hover:bg-gray-700" id="nav-overview">
                        🏠 대시보드
                    </a>
                    <a href="#" onclick="showTab('gantt')" 
                       class="block px-4 py-2 rounded hover:bg-gray-700" id="nav-gantt">
                        📅 내 업무 (Gantt)
                    </a>
                    <a href="#" onclick="showTab('voc')" 
                       class="block px-4 py-2 rounded hover:bg-gray-700" id="nav-voc">
                        📥 VOC 접수현황
                    </a>
                    <a href="#" onclick="showTab('baseline')" 
                       class="block px-4 py-2 rounded hover:bg-gray-700" id="nav-baseline">
                        📦 베이스라인
                    </a>
                    <a href="#" onclick="showTab('settings')" 
                       class="block px-4 py-2 rounded hover:bg-gray-700" id="nav-settings">
                        ⚙️ 설정
                    </a>
                </nav>
                
                <div class="mt-8 pt-4 border-t border-gray-700">
                    <button onclick="logout()" 
                            class="w-full px-4 py-2 bg-red-600 rounded hover:bg-red-700">
                        로그아웃
                    </button>
                </div>
            </div>

            <!-- 메인 컨텐츠 -->
            <div class="flex-1 overflow-auto p-8">
                <!-- 대시보드 개요 -->
                <div id="tab-overview" class="tab-content">
                    <h1 class="text-3xl font-bold mb-6">실시간 연구소 리소스 현황</h1>
                    
                    <!-- 3대 지표 카드 -->
                    <div class="grid grid-cols-3 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-gray-600 mb-2">인터럽트 비중</h3>
                            <div class="flex items-center justify-center h-32">
                                <canvas id="interruptChart"></canvas>
                            </div>
                            <p id="interruptWarning" class="text-sm text-center mt-2"></p>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-gray-600 mb-2">전체 프로젝트 진척</h3>
                            <div class="text-5xl font-bold text-center my-4" id="totalProgress">0%</div>
                            <p id="activeProjects" class="text-sm text-center text-gray-500"></p>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-gray-600 mb-2">연구원 가동률</h3>
                            <div class="text-5xl font-bold text-center my-4" id="avgUtilization">0%</div>
                            <p id="utilizationStatus" class="text-sm text-center text-gray-500"></p>
                        </div>
                    </div>

                    <!-- 프로젝트 로드맵 -->
                    <div class="bg-white p-6 rounded-lg shadow mb-8">
                        <h2 class="text-xl font-bold mb-4">프로젝트별 로드맵</h2>
                        <div id="projectList"></div>
                    </div>

                    <!-- 최근 VOC -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-bold mb-4">최근 유입된 주요 VOC</h2>
                        <div id="recentVOCs"></div>
                    </div>
                </div>

                <!-- 간트차트 탭 -->
                <div id="tab-gantt" class="tab-content hidden">
                    <h1 class="text-3xl font-bold mb-6">내 업무 일정</h1>
                    <div class="bg-white p-6 rounded-lg shadow mb-4">
                        <div class="mb-4">
                            <label class="block mb-2">프로젝트 선택:</label>
                            <select id="projectSelect" onchange="loadGantt()" 
                                    class="p-2 border rounded">
                            </select>
                        </div>
                        <div id="gantt"></div>
                    </div>
                </div>

                <!-- VOC 탭 -->
                <div id="tab-voc" class="tab-content hidden">
                    <h1 class="text-3xl font-bold mb-6">VOC 관리</h1>
                    
                    <div class="bg-white p-6 rounded-lg shadow mb-4">
                        <h2 class="text-xl font-bold mb-4">신규 VOC 등록</h2>
                        <input type="text" id="vocTitle" placeholder="제목" 
                               class="w-full p-2 border rounded mb-2">
                        <textarea id="vocContent" placeholder="내용" 
                                  class="w-full p-2 border rounded mb-2" rows="3"></textarea>
                        <div class="grid grid-cols-3 gap-4 mb-2">
                            <input type="text" id="vocDept" placeholder="요청 부서" 
                                   class="p-2 border rounded">
                            <input type="number" id="vocHours" placeholder="예상 시간" 
                                   class="p-2 border rounded">
                            <select id="vocUrgency" class="p-2 border rounded">
                                <option value="1">긴급도 1</option>
                                <option value="2">긴급도 2</option>
                                <option value="3" selected>긴급도 3</option>
                                <option value="4">긴급도 4</option>
                                <option value="5">긴급도 5</option>
                            </select>
                        </div>
                        <button onclick="submitVOC()" 
                                class="bg-blue-600 text-white px-6 py-2 rounded">
                            등록
                        </button>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-bold mb-4">VOC 목록</h2>
                        <div id="vocList"></div>
                    </div>
                </div>

                <!-- 베이스라인 탭 -->
                <div id="tab-baseline" class="tab-content hidden">
                    <h1 class="text-3xl font-bold mb-6">제품 버전 타임라인</h1>
                    <div id="baselineTimeline"></div>
                </div>

                <!-- 설정 탭 -->
                <div id="tab-settings" class="tab-content hidden">
                    <h1 class="text-3xl font-bold mb-6">설정</h1>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <p>설정 화면 (추후 구현)</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // 전역 변수
        // ============================================
        let currentUser = null;
        let ganttInstance = null;
        const API_URL = 'https://script.google.com/macros/s/AKfycbw1HAH_yamO4VFn2ONwkZAG_EVDCWKAY4xhIF1m0egyU-1WOOxrSo3H9dhXL_3wMr6H/exec'; // ⚠️ Apps Script URL로 교체

        // ============================================
        // API 호출
        // ============================================
        async function callAPI(action, params = {}) {
            const response = await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action, ...params })
            });
            return await response.json();
        }

        // ============================================
        // 로그인
        // ============================================
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            const result = await callAPI('auth', { email, password });
            
            if (result.success) {
                currentUser = result.user;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                document.getElementById('userName').textContent = result.user.name;
                document.getElementById('userRole').textContent = result.user.role;
                loadDashboard();
            } else {
                document.getElementById('loginError').textContent = result.error;
                document.getElementById('loginError').classList.remove('hidden');
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
        }

        // ============================================
        // 탭 전환
        // ============================================
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
            document.getElementById('tab-' + tabName).classList.remove('hidden');
            
            document.querySelectorAll('nav a').forEach(a => a.classList.remove('bg-gray-700'));
            document.getElementById('nav-' + tabName).classList.add('bg-gray-700');
            
            if (tabName === 'overview') loadDashboard();
            if (tabName === 'gantt') loadProjects();
            if (tabName === 'voc') loadVOCs();
            if (tabName === 'baseline') loadBaselines();
        }

        // ============================================
        // 대시보드 로딩
        // ============================================
        async function loadDashboard() {
            const stats = await callAPI('getDashboardStats');
            
            // 인터럽트 비중 차트
            const ctx = document.getElementById('interruptChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['인터럽트', '정규 업무'],
                    datasets: [{
                        data: [stats.interruptRatio, 100 - stats.interruptRatio],
                        backgroundColor: ['#ef4444', '#10b981']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
            
            const warning = stats.interruptRatio > 30 
                ? '<span class="text-red-600">⚠️ 주의: 30% 근접</span>' 
                : '<span class="text-green-600">✓ 정상</span>';
            document.getElementById('interruptWarning').innerHTML = warning;
            
            // 프로젝트 진척률
            document.getElementById('totalProgress').textContent = stats.totalProgress + '%';
            document.getElementById('activeProjects').textContent = 
                `(${stats.activeProjects}개 진행 중)`;
            
            // 가동률
            document.getElementById('avgUtilization').textContent = stats.avgUtilization + '%';
            const utilStatus = stats.avgUtilization > 90 ? '여유 인력 부족' : '정상';
            document.getElementById('utilizationStatus').textContent = `(${utilStatus})`;
            
            // 프로젝트 목록
            loadProjectSummary();
            
            // 최근 VOC
            loadRecentVOCs();
        }

        async function loadProjectSummary() {
            const projects = await callAPI('getProjects');
            const html = projects.map(p => `
                <div class="border-b py-3 flex justify-between items-center">
                    <div>
                        <strong>${p.title}</strong>
                        <div class="w-64 bg-gray-200 rounded h-2 mt-1">
                            <div class="bg-blue-600 h-2 rounded" style="width: ${p.actual_md / p.planned_md * 100}%"></div>
                        </div>
                    </div>
                    <span class="text-sm text-gray-600">담당: ${p.status}</span>
                </div>
            `).join('');
            document.getElementById('projectList').innerHTML = html;
        }

        async function loadRecentVOCs() {
            const vocs = await callAPI('getVOCs', { status: '검토' });
            const html = vocs.slice(0, 5).map(v => `
                <div class="border-b py-2 flex justify-between">
                    <span>[긴급도 ${v.urgency}] ${v.req_dept}</span>
                    <span class="text-sm text-gray-500">${v.status}</span>
                </div>
            `).join('');
            document.getElementById('recentVOCs').innerHTML = html || '<p class="text-gray-500">대기 중인 VOC가 없습니다.</p>';
        }

        // ============================================
        // 간트차트
        // ============================================
        async function loadProjects() {
            const projects = await callAPI('getProjects');
            const select = document.getElementById('projectSelect');
            select.innerHTML = projects.map(p => 
                `<option value="${p.project_id}">${p.title}</option>`
            ).join('');
            if (projects.length > 0) loadGantt();
        }

        async function loadGantt() {
            const projectId = document.getElementById('projectSelect').value;
            const tasks = await callAPI('getTasks', { project_id: projectId });
            
            const ganttTasks = tasks.map(t => ({
                id: t.task_id,
                name: `Task ${t.task_id}`,
                start: t.start_date,
                end: t.end_date,
                progress: t.progress,
                dependencies: t.dependencies || ''
            }));
            
            if (ganttInstance) ganttInstance.refresh(ganttTasks);
            else {
                ganttInstance = new Gantt("#gantt", ganttTasks, {
                    on_click: task => console.log(task),
                    on_date_change: (task, start, end) => {
                        callAPI('updateTask', {
                            task_id: task.id,
                            updates: { start_date: start, end_date: end }
                        });
                    }
                });
            }
        }

        // ============================================
        // VOC
        // ============================================
        async function submitVOC() {
            const data = {
                req_dept: document.getElementById('vocDept').value,
                lost_time_h: parseInt(document.getElementById('vocHours').value),
                urgency: parseInt(document.getElementById('vocUrgency').value)
            };
            
            await callAPI('addVOC', { data });
            alert('VOC가 등록되었습니다.');
            loadVOCs();
        }

        async function loadVOCs() {
            const vocs = await callAPI('getVOCs');
            const html = vocs.map(v => `
                <div class="border p-3 rounded mb-2">
                    <div class="flex justify-between">
                        <strong>${v.req_dept}</strong>
                        <span class="text-sm ${v.status === '검토' ? 'text-yellow-600' : 'text-green-600'}">
                            ${v.status}
                        </span>
                    </div>
                    <p class="text-sm text-gray-600">예상 시간: ${v.lost_time_h}h | 긴급도: ${v.urgency}</p>
                </div>
            `).join('');
            document.getElementById('vocList').innerHTML = html;
        }

        // ============================================
        // 베이스라인
        // ============================================
        async function loadBaselines() {
            const baselines = await callAPI('getBaselines');
            const html = baselines.map(b => `
                <div class="bg-white p-4 rounded shadow mb-3">
                    <div class="flex justify-between">
                        <div>
                            <strong>버전 ${b.version}</strong>
                            <p class="text-sm text-gray-600">${b.source_path}</p>
                        </div>
                        <span class="text-sm text-gray-500">${b.release_date}</span>
                    </div>
                </div>
            `).join('');
            document.getElementById('baselineTimeline').innerHTML = html;
        }

        // 초기화
        window.onload = () => {
            document.getElementById('loginEmail').focus();
        };
    </script>
</body>
</html>
